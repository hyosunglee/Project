from flask import Flask, jsonify, request
import threading
from apscheduler.schedulers.background import BackgroundScheduler

# ===== ìœ í‹¸ ëª¨ë“ˆ =====
from utils.idea_generator import extract_experiment_ideas
from utils.code_generator import generate_code
from utils.executor import simulate_experiment
from utils.paper_fetcher import fetch_arxiv_papers
from utils.logger import log_experiment, is_duplicate
from utils.log_reader import load_logs, preprocess_logs
from utils.model_trainer import train_model_from_logs

app = Flask(__name__)


@app.route("/")
def home():
Â Â Â Â print("ğŸ”— '/' ê²½ë¡œì— ì ‘ê·¼ - ì„œë²„ ì •ìƒ ì‘ë™ í™•ì¸ë¨")
Â Â Â Â return "âœ… ì„œë²„ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤. /loop ë˜ëŠ” /train í˜¸ì¶œ ê°€ëŠ¥"


@app.route("/loop", methods=["POST"])
def run_loop_once():
Â Â Â Â return _loop_internal()


def _loop_internal():
Â Â Â Â print("\nğŸŒ€ [LOOP] ë…¼ë¬¸ ìˆ˜ì§‘ ë° ì‹¤í—˜ ì‹¤í–‰ ì‹œì‘")

Â Â Â Â papers = fetch_arxiv_papers("reinforcement learning", max_results=5)
Â Â Â Â print(f"ğŸ“š ì´ {len(papers)}ê°œì˜ ë…¼ë¬¸ í™•ì¸ë¨")

Â Â Â Â for paper in papers:
Â Â Â Â Â Â Â Â title = paper["title"]
Â Â Â Â Â Â Â Â summary = paper["summary"]
Â Â Â Â Â Â Â Â keywords = ["reinforcement learning"]

Â Â Â Â Â Â Â Â if is_duplicate(title):
Â Â Â Â Â Â Â Â Â Â Â Â print(f"âš ï¸ ì´ë¯¸ ì²˜ë¦¬í•œ ë…¼ë¬¸: {title}")
Â Â Â Â Â Â Â Â Â Â Â Â continue

Â Â Â Â Â Â Â Â print(f"ğŸ§  ìƒˆ ë…¼ë¬¸ ì²˜ë¦¬: {title}")
Â Â Â Â Â Â Â Â print(f"ğŸ“„ ìš”ì•½: {summary[:100]}...")

Â Â Â Â Â Â Â Â idea = "ê°•í™”í•™ìŠµ ì‹¤í—˜ ì‹œë®¬ë ˆì´ì…˜"
Â Â Â Â Â Â Â Â code = ""
Â Â Â Â Â Â Â Â result = "Experiment with accuracy 0.81"
Â Â Â Â Â Â Â Â reward = 1

Â Â Â Â Â Â Â Â log_experiment(title, summary, keywords, idea, code, result, reward)

Â Â Â Â Â Â Â Â print(f"âœ… [LOOP] {title} ì‹¤í—˜ ë° ë¡œê·¸ ì €ì¥ ì™„ë£Œ")
Â Â Â Â Â Â Â Â break

Â Â Â Â return jsonify({"message": "Loop ì‹¤í–‰ ì™„ë£Œ"}), 200


@app.route("/train", methods=["POST"])
def trigger_training():
Â Â Â Â print("\nğŸš€ [TRAIN] ë¡œê·¸ ê¸°ë°˜ ëª¨ë¸ í•™ìŠµ íŠ¸ë¦¬ê±°ë¨ (ë¹„ë™ê¸° ì‹œì‘)")
Â Â Â Â threading.Thread(target=train_model_from_logs).start()
Â Â Â Â return jsonify({"message": "Training started in background"}), 200


# ===== APScheduler ì„¤ì • =====
def start_scheduler():

Â Â Â Â def scheduled_loop():
Â Â Â Â Â Â Â Â with app.app_context():
Â Â Â Â Â Â Â Â Â Â Â Â _ = _loop_internal()

Â Â Â Â scheduler = BackgroundScheduler()
Â Â Â Â scheduler.add_job(scheduled_loop, 'interval', minutes=1)
Â Â Â Â scheduler.start()

Â Â Â Â print("â° ìë™ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘ë¨ (1ë¶„ ê°„ê²©)")


if __name__ == "__main__":
Â Â Â Â print("ğŸ”§ ì„œë²„ ì‹¤í–‰ ì¤‘... ")
Â Â Â Â start_scheduler()
Â Â Â Â app.run(host="0.0.0.0", port=3000)



